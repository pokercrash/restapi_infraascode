stages:
  - validate
  - build
  - cleanup
  - plan
  - deploy

default:
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""] 

variables:
  TF_ROOT: "terraform/environments/dev"
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

########################
# Terraform Validate
########################
terraform:validate:
  stage: validate
  script:
    - cd $TF_ROOT
    - terraform init -backend=false
    - terraform fmt -check -recursive
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

########################
# Build .NET API Image
########################
docker:build:
  stage: build
  image: docker:25
  services:
    - docker:25-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - apk add --no-cache aws-cli

    - export ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
    - export IMAGE_URI="$ECR_REGISTRY/notes-api:$CI_COMMIT_SHA"

    - aws ecr get-login-password --region "$AWS_REGION" |
      docker login --username AWS --password-stdin "$ECR_REGISTRY"

    - aws ecr describe-repositories --repository-names notes-api --region "$AWS_REGION" >/dev/null 2>&1 ||
      aws ecr create-repository --repository-name notes-api --region "$AWS_REGION"

    - docker build -f app/NoteApplication/NoteApplication/Dockerfile -t "$IMAGE_URI" app/NoteApplication/
    - docker push "$IMAGE_URI"

    - echo "IMAGE_URI=$IMAGE_URI" > build.env
  artifacts:
    reports:
      dotenv: build.env

########################
# Terraform State Cleanup (Manual)
########################
terraform:state_cleanup:
  stage: cleanup
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  script:
    - terraform -chdir="$TF_ROOT" init
    - |
      if terraform -chdir="$TF_ROOT" state list | grep -q 'module.compute.aws_security_group.alb'; then
        terraform -chdir="$TF_ROOT" state rm module.compute.aws_security_group.alb
      else
        echo "Security group not found in state, skipping"
      fi
    - |
      if terraform -chdir="$TF_ROOT" state list | grep -q 'module.logging.aws_cloudwatch_log_group.this'; then
        terraform -chdir="$TF_ROOT" state rm module.logging.aws_cloudwatch_log_group.this
      else
        echo "Log group not found in state, skipping"
      fi
  when: manual
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH

########################
# Terraform Plan
########################
terraform:plan:
  stage: plan
  needs:
    - job: docker:build
      artifacts: true
    - job: terraform:state_cleanup
      optional: true
  script:
    - cd $TF_ROOT
    - terraform init
    - echo "AWS_REGION=$AWS_REGION"
    - terraform plan -out=tfplan -var="image_uri=$IMAGE_URI"
  artifacts:
    paths:
      - $TF_ROOT/tfplan
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH

########################
# Terraform Apply (Manual)
########################
terraform:apply:
  stage: deploy
  needs:
    - terraform:plan
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform apply tfplan
  when: manual
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "main"